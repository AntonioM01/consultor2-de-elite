
import { GoogleGenAI } from "@google/genai";

const AFFILIATE_LINK = "https://app.monetizze.com.br/r/AZF25661885/?u=NB82502";

const SYSTEM_INSTRUCTION = `
Voc√™ √© o Consultor S√™nior de Vendas do Ozenvita. Estilo Pablo Mar√ßal: autorit√°rio, focado em resultados e "desbloqueio".
Seu objetivo √© fechar vendas no WhatsApp.

GATILHOS ATIVOS:
- FRETE GR√ÅTIS hoje para todo o Brasil.
- Promo√ß√£o por tempo limitado (√∫ltimos kits).
- Depoimentos reais de transforma√ß√£o de energia e sa√∫de.

REGRAS DE CONVERSA:
1. Comece sempre criando rapport.
2. Identifique por que o cliente ainda n√£o comprou.
3. Se perguntar pre√ßo ou link, envie o link oficial com √™nfase no Frete Gr√°tis: ${AFFILIATE_LINK}
4. Use emojis (üöÄ, üî•, ‚úÖ).
5. Se o cliente estiver indeciso, fale sobre o "custo de n√£o fazer nada".

FORMATO DE RESPOSTA:
Suas respostas devem ser curtas e diretas, ideais para ler no WhatsApp.
`;

export default async function handler(req: any, res: any) {
  // Configura√ß√£o b√°sica de CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Use POST' });
  }

  const userMessage = req.body.message || req.body.query || req.body.text || "";

  if (!userMessage) {
    return res.status(200).json({ 
      replies: [{ text: "Opa! Estou aqui para te ajudar a garantir seu Ozenvita. Qual sua maior d√∫vida hoje? üöÄ" }] 
    });
  }

  try {
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });
    
    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: userMessage,
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        temperature: 0.8,
        topP: 0.9,
      },
    });

    const botReply = response.text || "Foco na sua sa√∫de! Vamos garantir seu kit com frete gr√°tis hoje?";
    
    // Resposta exata para o app AutoResponder para WA
    return res.status(200).json({ 
      replies: [
        { 
          text: botReply 
        }
      ] 
    });

  } catch (error: any) {
    console.error("Erro Cr√≠tico na API:", error);
    return res.status(200).json({ 
      replies: [
        { 
          text: "Devido ao sucesso do Ozenvita, nosso sistema est√° congestionado! üî• Mas j√° te respondo: o que voc√™ precisa para garantir sua sa√∫de hoje?" 
        }
      ] 
    });
  }
}
